<head>
  <%= stylesheet_link_tag 'tindex', media: 'all', 'data-turbolinks-track': 'reload' %>
</head>

<main class="tweets-index" data-page="tweets-index">
  <div class="top">
  <div class="top-action">
    <%= link_to "＋ イベント入力", new_tweet_path, class: "btn btn--cta" %>
  </div>
  <div class="top-action2">
    <%= link_to 'ログアウト', destroy_user_session_path, class: "btn btn--cta", data: {turbo_method: :delete} %>
  </div>
  </div>
  
<!-- 見出し -->
  <div class="page-head">
    <h3 class="page-head__title">イベント一覧</h3>
  </div>

  <!-- 一覧 -->
  <section class="tweets">
    <% if @tweets.present? %>
      <ul class="card-list">
        <% @tweets.each do |f| %>

          <% if user_signed_in? && current_user.id == f.user_id %>
          <li class="card tweet">
            <div class="card__body">
              <div class="tweet__head">
                <h4 class="tweet__title"><%= f.event.presence || "イベント名未登録" %></h4>
                <% if f.genre.present? %>
                  <span class="badge"><%= f.genre %></span>
                <% end %>
              </div>

              <dl class="meta">
                <% if f.name.present? %>
                  <div class="meta__row">
                    <dt>団体</dt>
                    <dd><%= f.name %></dd>
                  </div>
                <% end %>
                <div class="meta__row">
                  <dt>期間</dt>
                  <dd>
                    <% if f.datefrom.present? %>
                      <%= l f.datefrom, format: :simple %>
                    <% end %>
                    <% if f.dateto.present? %>
                      〜 <%= l f.dateto, format: :simple %>
                    <% end %>
                  </dd>
                </div>
                <% if f.area.present? %>
                  <div class="meta__row">
                    <dt>地区</dt>
                    <dd><%= f.area %></dd>
                  </div>
                <% end %>
                <% if f.address.present? %>
                  <div class="meta__row">
                    <dt>住所</dt>
                    <dd><%= f.address %></dd>
                  </div>
                <% end %>
                <% if f.about.present? %>
                  <div class="meta__row">
                    <dt>概要</dt>
                    <dd><%= truncate(f.about, length: 120) %></dd>
                  </div>
                <% end %>
                <% if f.eventurl.present? %>
                  <div class="meta__row">
                    <dt>URL</dt>
                    <dd>
                      <%= link_to f.eventurl, f.eventurl, target: "_blank", rel: "noopener",
                                   class: "link link--ellipsis", title: f.eventurl %>
                    </dd>
                  </div>
                <% end %>
              </dl>
              
              <div class="card_three">
              <div class="card__actions">
                <%= link_to "編集する", edit_tweet_path(f.id), class: "btn btn--primary"%>
              </div>
              <div class="card__actions">
                <%= link_to "削除する", tweet_path(f.id), class: "btn btn--primary", data: {turbo_method: :delete, turbo_confirm: "本当に削除しますか"} %>
              </div>
              </div>

              <% end %>


            </div>
          </li>
        <% end %>
      </ul>
    <% else %>
      <div class="empty">
        <p>イベントがありません。</p>
        <p class="empty__hint"></p>
      </div>
    <% end %>
  </section>

  <!-- マップ -->
  <section class="map-wrap">
    <h2 class="section-title">イベントマップ</h2>

    <div id="map" class="map"></div>
  </section>
</main>

<!-- 既存のJSはそのまま -->
<script>
  function initMap() {
    let latlng = new google.maps.LatLng(35.3338, 139.4036);

    let styles = [{ stylers: [{ "saturation": 0 }, { "lightness": 0 }] }];

    let map = new google.maps.Map(document.getElementById('map'), {
      zoom: 13,
      styles: styles,
      center: latlng
    });

    let transitLayer = new google.maps.TransitLayer();
    transitLayer.setMap(map);

    // マーカー
    <% @tweets.each do |tweet| %>
      <% if user_signed_in? && current_user.id == tweet.user_id %>
      (function() {
        let markerLatLng = { lat: <%= tweet.lat || 0 %>, lng: <%= tweet.lng || 0 %> };
        let marker = new google.maps.Marker({ position: markerLatLng, map: map });
        let infowindow = new google.maps.InfoWindow({
          position: markerLatLng,
          content: "<a href='<%= tweet_url(tweet.id) %>' target='_blank'><%= j(tweet.name.to_s) %></a>"
        });
        marker.addListener('click', function() { infowindow.open(map, marker); });
      })();
    <% end %>
    <% end %>
  }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-NjstGmUv9_Hup6T205DA6XakFEDjmoQ&callback=initMap" async defer></script>